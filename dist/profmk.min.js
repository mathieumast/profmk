/*
 * Compact promise pattern implementation and more.
 * Version : 1.0.1
 * Copyright (c) 2013 - 2014, Mathieu MAST https://github.com/mathieumast/profmk
 * Licensed under the MIT license
 */
(function(){"use strict";var profmk={};profmk.slice=function(array,start,end){return end?Array.prototype.slice.call(array,start,end):start?Array.prototype.slice.call(array,start):Array.prototype.slice.call(array)},profmk.invoke=function(context,func){return func.apply(context,profmk.slice(arguments,2))},profmk.invokeAsync=function(context,func){setTimeout(function(){func.apply(context,profmk.slice(arguments,2))},1)},profmk.async=function(context,func){var _future=profmk.future(),args=profmk.slice(arguments,2);return setTimeout(function(){_future.notifyDone(func.apply(context,args))},1),_future.promise()},profmk.extend=function(dest){for(var prop,args=profmk.slice(arguments,1),i=0,l=args.length;l>i;i++)for(prop in args[i])dest[prop]=args[i][prop];return dest},profmk.instantiate=function(func,array){var i=0,l=array.length?array.length:0,q=[];switch(l){case 0:return new func;case 1:return new func(array[0]);case 2:return new func(array[0],array[1]);case 3:return new func(array[0],array[1],array[2]);case 4:return new func(array[0],array[1],array[2],array[3]);default:for(;l>i;i++)q.push("array["+i+"]");return eval("new func("+q.join(",")+");")}};var _Subscriber=function(channel,callback,priority,context){this.channel=channel,this.originalCallback=callback,this.callback=callback,this.priority=priority?priority:10,this.context=context?context:profmk},_Register=function(subscribersMap){var _subscribersMap=subscribersMap;this.subscribe=function(subscriber){if(_subscribersMap[subscriber.channel]||(_subscribersMap[subscriber.channel]=[]),"function"!=typeof subscriber.callback)return this;var subs=_subscribersMap[subscriber.channel],i=subs.length-1;for(subscriber.i=i+1;i>=0;i--)if(subscriber.priority>=subs[i].priority)return subs.splice(i+1,0,subscriber),this;return subs.unshift(subscriber),this},this.unsubscribe=function(channel,callback){if(!_subscribersMap[channel])return this;if(callback)for(var array=_subscribersMap[channel],i=array.length-1;i>=0;i--)array[i].originalCallback===callback&&array.splice(i,1);else _subscribersMap[channel]=null;return this}},_Publisher=function(subscribersMap){var _subscribersMap=subscribersMap;this.publishArray=function(channel,array){profmk.invokeAsync(this,function(){_subscribersMap[channel]||(_subscribersMap[channel]=[]);for(var subs=profmk.slice(_subscribersMap[channel]),i=0,l=subs?subs.length:0;l>i;i++)if(subs[i].callback.apply(subs[i].context,array)===!1)return!1;return!0})}},_Mediator=function(){var _subscribersMap={};this._register=new _Register(_subscribersMap),this._publisher=new _Publisher(_subscribersMap)};_Mediator.prototype.subscribe=function(channel,callback,priority,context){return this._register.subscribe(new _Subscriber(channel,callback,priority,context)),this},_Mediator.prototype.subscribeOnce=function(channel,callback,priority,context){var sub=new _Subscriber(channel,callback,priority,context),self=this;return sub.callback=function(){var res=sub.originalCallback.apply(context,arguments);return self._register.unsubscribe(sub.channel,sub.originalCallback),res},this._register.subscribe(sub),this},_Mediator.prototype.unsubscribe=function(channel,callback){return this._register.unsubscribe(channel,callback),this},_Mediator.prototype.publish=function(channel){return this._publisher.publishArray(channel,profmk.slice(arguments,1))},_Mediator.prototype.publishArray=function(channel,array){return this._publisher.publishArray(channel,array)},profmk.mediator=function(){return new _Mediator};var _Promise=function(subscribersMap){this._register=new _Register(subscribersMap)};_Promise.prototype.then=function(done,fail,progress,context){return this._register.subscribe(new _Subscriber("done",done,null,context)),this._register.subscribe(new _Subscriber("fail",fail,null,context)),this._register.subscribe(new _Subscriber("progress",progress,null,context)),this};var _Future=function(){var _step="progress",_subscribersMap={},_promise=new _Promise(_subscribersMap),_publisher=new _Publisher(_subscribersMap);this.context=this,this._notify=function(type,array){return"progress"===_step&&(_step=type,_publisher.publishArray(type,array)),this},this.promise=function(){return _promise}};_Future.prototype.then=function(done,fail,progress){this.promise().then(done,fail,progress)},_Future.prototype.notifyDone=function(){return this._notify("done",profmk.slice(arguments))},_Future.prototype.notifyFail=function(){return this._notify("fail",profmk.slice(arguments))},_Future.prototype.notifyProgress=function(){return this._notify("progress",profmk.slice(arguments))},profmk.future=function(){return new _Future};var _When=function(objs){profmk.extend(this,new _Future);for(var _results=[],_remaining=objs.length,i=0,l=objs.length,_self=this;l>i;i++){var promise,elem=objs[i];promise=elem?"function"==typeof elem.then?"function"==typeof elem.promise?elem.promise():elem:"function"==typeof elem?profmk.async(_self,elem,profmk.slice(arguments,2)):profmk.future().notifyDone(elem).promise():profmk.future().notifyDone(null).promise(),profmk.invoke(_self,function(i,promise){promise.then(function(obj){_results[i]=obj,0===--_remaining?_Future.prototype.notifyDone.apply(_self.context,_results):_self.context.notifyProgress(obj)},function(obj){_self.context.notifyFail(obj)},function(obj){_self.context.notifyProgress(obj)})},i,promise)}};profmk.extend(_When.prototype,_Future.prototype),profmk.when=function(){var when=new _When(profmk.slice(arguments));return when.promise()},profmk.wait=function(ms){var future=profmk.future(),objs=[future].concat(profmk.slice(arguments,1)),when=new _When(objs);return setTimeout(function(){future.notifyDone(ms)},ms),when.promise()},profmk.timeout=function(ms){var when=new _When([ms].concat(profmk.slice(arguments,1)));return setTimeout(function(){when.notifyFail("Timeout error")},ms),when.promise()},"function"==typeof define&&define.amd&&define("profmk",[],function(){return profmk});var root="undefined"!=typeof exports&&null!==exports?exports:this;"undefined"!=typeof module&&module.exports&&(module.exports=profmk),root.profmk=profmk}).call(this);